name: Deploy latest version to Github Releases

on:
  push:
    branches:
      - master
    paths:
      - 'src/**'
  workflow_dispatch:

permissions:
  contents: write
  
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    environment: production
    runs-on: windows-latest

    steps:  
      - name: Send Discord Webhook
        shell: pwsh
        env:
          WEBHOOK: ${{ secrets.DER_WEBHOOK }}
          REPO: ${{ github.repository }}
          JOB_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          $payload = @{
            username = "GitHub Actions"
            embeds = @(
              @{
                title = "$env:REPO"
                description = "ðŸš€ Build started"
                color = 5814783
                fields = @(
                  @{
                    name  = "Commit"
                    value = $env:COMMIT_MESSAGE
                  },
                  @{
                    name  = "Job Link"
                    value = $env:JOB_URL
                  }
                )
              }
            )
          } | ConvertTo-Json -Depth 5
          Invoke-RestMethod -Uri $env:WEBHOOK -Method Post -ContentType "application/json" -Body $payload
          
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get version info
        uses: dotnet/nbgv@master
        id: nbgv

      - name: Setup .NET 10 SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Dotnet Publish
        run: |
          dotnet publish src/LoneSpoof.csproj `
            -c Release `
            -r win-x64 `
            --self-contained `
            /p:DebugType=None `
            /p:DebugSymbols=false `
            /p:Version=${{ steps.nbgv.outputs.SemVer2 }} `
            /p:FileVersion=${{ steps.nbgv.outputs.AssemblyFileVersion }} `
            /p:AssemblyVersion=${{ steps.nbgv.outputs.AssemblyVersion }} `
            -o out
      
      - name: Archive publish output
        run: |
          cd out
          Compress-Archive -Path * -DestinationPath "..\LoneSpoof.zip" -Force
        
      - name: Upload to "latest" release (overwrite old asset)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload latest LoneSpoof.zip --clobber
